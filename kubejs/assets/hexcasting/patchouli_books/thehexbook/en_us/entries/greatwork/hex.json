{
  "name": "一",
  "category": "hexcasting:greatwork",
  "icon": "hexcasting:staff/quenched",
  "sortnum": 0,
  "advancement": "hexcasting:enlightenment",
  "entry_color": "54398a",
  "secret": true,
  "pages": [
    {
      "type": "patchouli:text",
      "title": "咒术机理的书写艺术",
      "text": "咒法执行系统是一个函数式虚拟机在Minecraft中的实现，分三层架构：$(br)$(li)1.咒法虚拟机：CastingVM$(br)$(li)2.咒法映像：CastingImage$(br)$(li)3.环境：CastingEnvironment$(br2)施法时，依次进行初始化，元运行与持久化。"
      
    },
    {
      "type": "patchouli:text",
      "text": "$(li)1.咒法虚拟机：负责管理执行流程，包括执行栈的推进、转义处理、错误处理、副作用的调度应用。$(br)$(li)2.咒法映像：记录当前咒法的所有内部状态，包括数据栈、括号状态、操作计数和自定义数据，将其封装与序列化保存，所有状态字段均不可变，每次执行产生新实例。$(br)$(li)3.施法环境：咒法执行与世界交互的接口，定义施法者和条件，负责资源管理、权限检查、范围验证和反馈。"
    },
    {
      "type": "patchouli:text",
      "text": "首先是初始化阶段：$(br)$(li)1.创建初始咒法映像$(br)$(li)2.创建施法环境实例$(br)$(li)3.结合二者构造咒法虚拟机$(br)$(li)4.传入要执行的 iota 列表$(br2)之后便在虚拟机中进入执行阶段，虚拟机将 iota 列表包装为执行帧，推入执行栈。然后进入主循环。"
    },
    {
      "type": "patchouli:text",
      "text": "只要执行栈非空且未提前退出，则：$(li)a.取出执行栈顶的执行帧$(br)$(li)b.从执行帧中取出下一个待执行的 iota，进行内部执行$(br)$(li)c.处理括号系统，如果未被转义，则匹配图案并执行$(br)$(li)d.返回施法结果，包含新状态、新执行栈和副作用列表$(br)$(li)e.更新咒法映像和执行栈$(br)$(li)f.应用副作用，如有事故则提前退出"
    },
    {
      "type": "patchouli:text",
      "text": "之后便在咒法映像中进入持久化阶段，施法环境和咒法虚拟机状态不保存，每次施法时将重新创建。$(br2)咒法映像则将序列化为 NBT 数据保存，若创建初始化阶段创建咒法映像时存在保存的映像，则将其读取并解析。$(br2)以上便是三层架构与三个阶段的概括说明，然后是对于三层架构的详细说明，并结合元运行等核心图案进行解析。"
    },
    {
      "type": "patchouli:text",
      "title": "施法环境",
      "text": "施法环境是咒法执行与世界交互的抽象接口，负责：$(br)$(li)1.获取施法者与施法手$(br)$(li)2.进行媒质提取与物品操作$(br)$(li)3.进行范围验证与权限验证$(br2)施法环境通过组件架构支持功能扩展，每一种操作都隶属于图案执行后处理，施法结束后处理，媒质提取前/后处理与范围检查处理四个组件其中之一。"
    },
    {
      "type": "patchouli:text",
      "text": "施法者的施法环境由施法者，施法手，施法范围和哨位影响半径组成。判断范围时，优先判断范围是否在卓越哨位的半径之中。$(br2)消耗媒质时，遍历施法者身上的媒质源进行提取；如果不足，则尝试消耗生命值进行提取，然后根据消耗后生命的差值计算转化出的媒质量。施法者的施法环境由法杖施法环境与造物施法环境扩展，又与法术环施法共同扩展施法环境。"
    },
    {
      "type": "patchouli:text",
      "text": "法杖施法环境执行时：$(br)$(li)1.将笔顺匹配为图案$(br)$(li)2.获取法杖虚拟机实例$(br)$(li)3.应用图案 iota 的执行$(br)$(li)4.如果栈清空，清除咒法映像和图案列表，否则保存$(br2)造物施法会先尝试优先在造物中提取所需的媒质，然后再从玩家身上提取。法术环施法时，无主法术环视为已被启迪，施法手视为主手。绑定施法者后，扩展其施法范围。"
    },
    {
      "type": "patchouli:text",
      "title": "咒法映像",
      "text": "咒法映像记录咒法虚拟机的完整状态，所有字段均为只读，不可修改。更新通过复制以创建新实例，其中包含六大部分。$(br2)将完整状态序列化为 NBT 数据时，在上述六种信息中，括号内 iota 和转义标记将分别存储。如果括号内的 iota 列表过大无法序列化，将会替换为空列表。从 NBT 数据恢复为咒法映像的过程同样分为六个环节。"
    },
    {
      "type": "patchouli:text",
      "text": "咒法映像数据：$(br)$(li)1.stack: 栈中的 iota 数据$(br)$(li)2.parenCount: 当前括号深度$(br)$(li)3.parenthesized: 括号内暂存的 iota 及转义状态$(br)$(li)4.escapeNext: 下一个 iota 是否将被转义$(br)$(li)5.opsConsumed: 操作计数$(br)$(li)6.userData: 用户数据，包含渡鸦之思和驱动标记。"
    },
    {
      "type": "patchouli:text",
      "text": "数据恢复环节：$(br)$(li)1.反序列化数据栈 - 遍历 stack 列表，对每个数据尝试解析为 iota$(br)$(li)2.反序列化用户数据$(br)$(li)3.反序列化括号内容$(br)$(li)4.读取括号深度，转义标记和操作计数$(br)$(li)5.创建咒法映像$(br)$(li)6.异常时记录事故，返回空映像"
    },
    {
      "type": "patchouli:text",
      "title": "咒法虚拟机",
      "text": "咒法虚拟机由咒法映像与施法环境共同构造，根据输入的 iota 决定咒法映像的下一次迭代。咒法映像执行过程中会被更新；施法环境不可变，用于与世界交互。$(br2)传入图案列表和当前世界便可开始执行：创建空栈，将输入的 iota 列表包装为执行帧推入栈顶，只要执行栈非空且未提前退出，则判断栈顶帧是否可执行且大小正常，执行并返回结果，更新咒法映像与执行栈。"
    },
    {
      "type": "patchouli:text",
      "text": "虚拟机处理执行帧时：$(br)$(li)1.检查列表状态，若列表非空，则取出首个待执行图案；若为空，则返回结果。$(br)$(li)2.准备后续执行，若列表中仍有剩余图案，则将剩余部分包装为新的执行帧，推入延续栈。$(br)$(li)3.执行当前图案，调用虚拟机内部执行，执行列表中的首个图案，并获取执行结果。"
    },
    {
      "type": "patchouli:text",
      "text": "$(li)4.返回执行结果，将更新后的咒法映像、延续状态及副作用列表封装为施法结果返回。$(br2)在虚拟机的内部执行中，首先进行括号系统的处理，若已被括号系统处理，则返回处理结果，不进行图案匹配。若未处理，对于图案 iota，则进行图案匹配和执行。所有异常在内部捕获，并转换为事故被处理，事故会将延续设为空以此中断虚拟机的后续执行。"
    },
    {
      "type": "patchouli:text",
      "text": "括号系统内含三个参数，代表当前打开的括号深度，括号内暂存的 iota 及其转义状态，和下一个 iota 是否将被转义。$(br2)系统会将输入的 iota 转换为图案 iota，并提取其角度值用于匹配考察等特殊图案。考察或探知将为系统添加一次性的转义状态，被转义的 iota 在被运行时不会匹配为图案。当括号数归零时，括号内暂存的 iota 列表将作为列表 iota 压回，并结束括号状态。"
    },
    {
      "type": "patchouli:text",
      "text": "元运行的奥秘由此便明了。赫尔墨斯之策略创建一个施法边界，卡戎之策略的停止效果也最多至此。然后将栈顶的图案列表包装为执行帧压入延续之中，厄科之策略不过是压入指定数目。$(br2)托特之策略创建的则另一种特殊的遍历帧，从第二次执行开始将上次代码执行后的栈状态存入累加器，恢复基准栈状态，确保每次迭代在相同初始条件下进行。每次迭代取出起始元素处理为执行帧，剩余数据与新基准栈封装为下一迭代帧。"
    },
    {
      "type": "patchouli:text",
      "text": "伊西斯之策略的书签 iota 就是延续，包含当前与所有将要执行的帧，当其被运行时，则将当前延续替换为记录的延续。$(br2)修普诺斯之策略则创建了一个新的咒法虚拟机，若施法环境属于为玩家基础施法环境则由此创建法杖施法环境；若不是玩家基础类，则继承原环境，由此施法环境构造虚拟机。同时将用户数据从当前咒法映像中获取并传入。"
    }
  ]
}